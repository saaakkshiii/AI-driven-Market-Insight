<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Diagnostics — AI Models</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="app-title">Model Diagnostics</h2>
        <div class="muted">Training metrics and feature importance</div>
      </div>
      <div>
        <a class="btn btn-primary me-2" href="/">Back</a>
        <a class="btn btn-outline-light" href="/retrain">Retrain Models</a>
      </div>
    </div>

    {% if not metrics %}
      <div class="card p-3">
        <p class="muted">No diagnostics found. Run training to generate <code>model_results.json</code>.</p>
      </div>
    {% else %}
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card p-3">
            <h5>R² Scores</h5>
            <canvas id="r2Chart" height="140"></canvas>
            <small class="muted">Higher is better (max = 1.0).</small>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card p-3">
            <h5>MSE (lower is better)</h5>
            <canvas id="mseChart" height="140"></canvas>
            <small class="muted">Mean Squared Error on the test holdout set.</small>
          </div>
        </div>

        {% if metrics.feature_importance and metrics.feature_columns %}
        <div class="col-12">
          <div class="card p-3">
            <h5>Feature Importance (GBR)</h5>
            <canvas id="fiChart" height="100"></canvas>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card p-3 mt-4">
        <h6>Raw metrics</h6>
        <pre>{{ metrics | tojson(indent=2) }}</pre>
      </div>
    {% endif %}
  </div>

  <script>
    const metrics = {{ metrics | tojson }};
    if (metrics && metrics.results) {
      const names = Object.keys(metrics.results);
      const r2s = names.map(n => metrics.results[n].R2);
      const mses = names.map(n => metrics.results[n].MSE);

      new Chart(document.getElementById('r2Chart'), {
        type: 'bar',
        data: { labels: names, datasets: [{ label: 'R²', data: r2s, backgroundColor: ['#61dafb','#4fb3ff','#2da9ff'] }] },
        options: { scales: { y: { beginAtZero: true, max: 1 } }, plugins: { legend:{ display:false } } }
      });

      new Chart(document.getElementById('mseChart'), {
        type: 'bar',
        data: { labels: names, datasets: [{ label: 'MSE', data: mses, backgroundColor: ['#ff9f43','#ff6b6b','#ffa94d'] }] },
        options: { scales: { y: { beginAtZero: true } }, plugins: { legend:{ display:false } } }
      });

      if (metrics.feature_importance && metrics.feature_columns) {
        new Chart(document.getElementById('fiChart'), {
          type: 'bar',
          data: { labels: metrics.feature_columns, datasets: [{ label: 'Importance', data: metrics.feature_importance, backgroundColor: '#37a2eb' }] },
          options: { scales: { y: { beginAtZero: true } }, plugins: { legend:{ display:false } } }
        });
      }
    }
  </script>
</body>
</html>
